<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>layui</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/plugins/layui/css/layui.css" media="all">
    <!--ztree-->
    <link rel="stylesheet" href="/plugins/zTree/css/demo.css" type="text/css">
    <link rel="stylesheet" href="/plugins/zTree/css/zTreeStyle/zTreeStyle.css" type="text/css">


    <style>
        body {
            padding: 16px;
        }

        div.content_wrap {
            width: 260px;
        }

        .zTreeDemoBackground {
            width: 260px;
        }

        ul.ztree {
            background-color: #FFF;
            border: none;
            height: 500px;
        }
    </style>


</HEAD>
<body>
<div style="width:260px; display: inline-block;float: left">
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>菜单信息</legend>
    </fieldset>
    <div class="content_wrap">
        <div class="zTreeDemoBackground">
            <ul id="treeDemo" class="ztree"></ul>
        </div>
    </div>
</div>
<div style="display: inline-block; width:500px;">

    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>角色信息</legend>
    </fieldset>

    <form id="app" class="layui-form" action="">
        <div class="layui-form-item">
            <label class="layui-form-label">角色名称</label>
            <div class="layui-input-block">
                <input name="name" type="text" autocomplete="off"
                       class="layui-input" :value="obj.name">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">角色标识</label>
            <div class="layui-input-block">
                <input name="roleType" type="text" autocomplete="off"
                       class="layui-input" :value="obj.roleType">
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">描述</label>
            <div class="layui-input-block">
                <textarea name="description" placeholder="请输入内容" class="layui-textarea">{{obj.description}}</textarea>
            </div>
        </div>
        <div class="layui-form-item layui-form-text" style="display: none">
            <label class="layui-form-label">meunIds</label>
            <div class="layui-input-block">
                <input name="meunIds[]" type="text" autocomplete="off"
                       class="layui-input" :value="meunIds">
            </div>
        </div>

        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit="" lay-filter="demo1">立即提交</button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
</div>

<input id="json" type="text" style="display: none" value="{}">
<!--tree-->
<script src="/plugins/jQuery/jquery-2.2.3.min.js"></script>
<script type="text/javascript" src="/plugins/zTree/js/jquery.ztree.core.js"></script>
<script type="text/javascript" src="/plugins/zTree/js/jquery.ztree.excheck.js"></script>
<!--表单组件-->
<script src="https://cdn.bootcss.com/vue/2.2.0/vue.min.js"></script>
<script src="/plugins/layui/layui.js"></script>
<script src="https://cdn.bootcss.com/jquery.form/3.51/jquery.form.min.js"></script>
<script src="/dist/js/zTree_menu.js"></script>

<script>
    (function () {
        var id = 0;
        var app;
        var path = "/api/role/";
        layui.use(['form', 'layedit', 'laydate'], function () {
            var form = layui.form()
                , layer = layui.layer

            //自定义验证规则
            form.verify({
                name: function (value) {
                    if (value.length < 3) {
                        return '名称至少得3个字符啊';
                    }
                }
            });

            //监听提交
            form.on('submit(demo1)', function (data) {
                if (id == 0) {
                    add();
                } else {
                    edit()
                }
                return false;
            });
            var f = function () {
                //渲染页面
                var obj = JSON.parse($("#json").val());
                id = obj.id == undefined ? 0 : obj.id;
                console.log('json-obj', obj)
                app = new Vue({
                    el: '#app',
                    data: {
                        obj: obj,
                        meunIds: []
                    }
                })
                var role_id = id;
                buildZTreeMenus(role_id);
            }
            setTimeout(f, 200)
        });

        function edit() {
            var url = path + id;
            var method = "PUT";
            save(url, method);
            console.log("PUT")
        }

        function add() {
            var url = path;
            var method = "POST";
            save(url, method);
            console.log("post")
        }

        function save(url, method) {
            var options = {
                url: url,
                method: method,
                success: function (data) {
                    layer.msg(data.msg)
                }
            };
            $("#app").ajaxSubmit(options)
        }

        var menus = [];
        <!--z_tree-->
        function buildZTreeMenus(role_id) {
            buildRoleMenusChecked(role_id, function (zNodes, roleMenuIds) {
                menus = roleMenuIds;
                app.meunIds = menus;
                function onCheck(e, treeId, treeNode) {
                    var treeObj = $.fn.zTree.getZTreeObj("treeDemo"),
                        nodes = treeObj.getCheckedNodes(true);
                    menus = [];
                    for (var i = 0; i < nodes.length; i++) {
                        menus.push(nodes[i].id); //获取选中节点的值
                    }
                    app.meunIds = menus;
                }

                var setting = {
                    check: {
                        enable: true,
                        chkboxType: {"Y": "ps", "N": "ps"}
                    },
                    data: {
                        simpleData: {
                            enable: true
                        }
                    },
                    callback: {
                        onCheck: onCheck
                    }
                };
                $.fn.zTree.init($("#treeDemo"), setting, zNodes);
            })
        }

    })();

</script>

</body>
</html>